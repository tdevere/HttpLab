<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HTTPS Handshake Terminal Map - Interactive Tutorial</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        h1 {
            text-align: center;
            color: #667eea;
            margin-bottom: 10px;
            font-size: 2.5em;
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 1.2em;
        }

        .osi-primer {
            background: #f8f9fa;
            border-left: 5px solid #667eea;
            padding: 20px;
            margin-bottom: 30px;
            border-radius: 5px;
        }

        .osi-primer h2 {
            color: #667eea;
            margin-bottom: 15px;
        }

        .osi-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            background: white;
        }

        .osi-table th, .osi-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        .osi-table th {
            background: #667eea;
            color: white;
        }

        .osi-table tr:hover {
            background: #f1f1f1;
        }

        .map-container {
            display: flex;
            flex-direction: column;
            margin: 30px 0;
            position: relative;
        }

        .map-line {
            position: absolute;
            left: 30px;
            top: 0;
            bottom: 0;
            width: 4px;
            background: linear-gradient(to bottom, #667eea, #764ba2);
            z-index: 0;
        }

        .stop {
            padding: 20px 20px 20px 70px;
            border: 3px solid #ddd;
            margin: 15px 0;
            cursor: pointer;
            background: white;
            border-radius: 10px;
            transition: all 0.3s ease;
            position: relative;
            z-index: 1;
        }

        .stop::before {
            content: '';
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            width: 30px;
            height: 30px;
            background: white;
            border: 4px solid #667eea;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .stop:hover {
            border-color: #667eea;
            transform: translateX(10px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .stop.active {
            border-color: #667eea;
            background: #e6f7ff;
            font-weight: bold;
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .stop.active::before {
            background: #667eea;
            box-shadow: 0 0 10px rgba(102, 126, 234, 0.6);
        }

        .stop-title {
            font-size: 1.3em;
            color: #333;
            margin-bottom: 5px;
        }

        .stop-layer {
            font-size: 0.9em;
            color: #666;
            font-style: italic;
        }

        .details {
            margin-top: 30px;
            padding: 25px;
            border-left: 5px solid #667eea;
            background: #f8f9fa;
            border-radius: 5px;
            display: none;
            animation: fadeIn 0.5s;
        }

        .details.show {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .details h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.8em;
        }

        .details p {
            line-height: 1.8;
            margin-bottom: 15px;
            color: #555;
        }

        .details ul {
            margin-left: 20px;
            margin-bottom: 15px;
        }

        .details li {
            margin-bottom: 10px;
            line-height: 1.6;
        }

        .highlight {
            background: #fff3cd;
            padding: 2px 6px;
            border-radius: 3px;
            font-weight: bold;
        }

        .code-block {
            background: #2d2d2d;
            color: #f8f8f2;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            margin: 15px 0;
            overflow-x: auto;
        }

        .test-button {
            display: block;
            margin: 30px auto;
            padding: 15px 30px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 25px;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .test-button:hover {
            background: #764ba2;
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .button-row {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 30px;
        }

        .secondary-button {
            background: #f1f3ff;
            color: #667eea;
            border: 2px solid #667eea;
        }

        .secondary-button:hover {
            background: #e0e5ff;
        }

        .legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 3px solid;
        }

        .layer-7 { border-color: #ff6b6b; }
        .layer-6 { border-color: #4ecdc4; }
        .layer-5 { border-color: #45b7d1; }
        .layer-4 { border-color: #96ceb4; }
        .layer-3 { border-color: #ffeaa7; }
        .layer-2 { border-color: #dfe6e9; }
        .layer-1 { border-color: #636e72; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîí HTTPS Connection: The Terminal Map</h1>
        <p class="subtitle">An Interactive Journey Through Secure Web Communication</p>

        <!-- Experimental: HTTPS Learning Lab strip (does not replace main map) -->
        <div id="learning-lab" style="margin-top: 20px; margin-bottom: 30px; padding: 25px; border-radius: 10px; background: #f5f7ff; border: 1px dashed #667eea;">
            <h2 style="text-align: center; color: #667eea; margin-bottom: 10px;">HTTPS Learning Lab (Beta)</h2>
            <p style="text-align: center; color: #555; margin-bottom: 20px;">
                Watch the HTTPS handshake play out like a rapid-transit journey.
            </p>

            <div id="lab-line" style="position: relative; margin: 30px auto 15px auto; max-width: 800px; height: 80px;">
                <div style="position: absolute; top: 50%; left: 5%; right: 5%; height: 4px; background: linear-gradient(90deg, #667eea, #764ba2);"></div>
                <!-- Stops are created dynamically in JS so we stay in sync with stepsData -->
            </div>

            <div style="display: flex; justify-content: center; gap: 12px; margin-bottom: 20px;">
                <button class="test-button" type="button" id="lab-play-button" style="padding: 10px 22px; font-size: 0.95em;">
                    ‚ñ∂ Play Journey
                </button>
                <button class="test-button secondary-button" type="button" id="lab-pause-button" style="padding: 10px 22px; font-size: 0.95em; display: none;">
                    ‚è∏ Pause
                </button>
            </div>

            <div id="lab-status" style="text-align: center; font-size: 1.05em; color: #333; margin-bottom: 10px;"></div>

            <div id="lab-errors" style="max-width: 900px; margin: 0 auto; font-size: 0.9em; color: #333;">
                <div style="text-align: center; margin-bottom: 8px; font-weight: 600;">Common issues at this stage</div>
                <ul id="lab-errors-list" style="list-style: none; padding-left: 0; margin: 0;"></ul>
            </div>

            <p style="text-align: center; font-size: 0.9em; color: #555; margin-top: 12px;">Use the Learning Lab to get the overview, then scroll down to explore each stop in detail.</p>
        </div>

        <div class="osi-primer">
            <h2>üìö OSI Model Primer</h2>
            <p>The <strong>OSI (Open Systems Interconnection) Model</strong> is a conceptual framework that standardizes how different networking systems communicate. It has 7 layers, each with specific responsibilities:</p>
            
            <table class="osi-table">
                <thead>
                    <tr>
                        <th>Layer</th>
                        <th>Name</th>
                        <th>Function</th>
                        <th>HTTPS Role</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>7</td>
                        <td>Application</td>
                        <td>Application-level services</td>
                        <td>The HTTPS Request/Response</td>
                    </tr>
                    <tr>
                        <td>6</td>
                        <td>Presentation</td>
                        <td>Data formatting & encryption</td>
                        <td>TLS/SSL Encryption</td>
                    </tr>
                    <tr>
                        <td>5</td>
                        <td>Session</td>
                        <td>Connection management</td>
                        <td>TLS/SSL Session Control</td>
                    </tr>
                    <tr>
                        <td>4</td>
                        <td>Transport</td>
                        <td>Reliable data transfer</td>
                        <td>TCP Three-Way Handshake</td>
                    </tr>
                    <tr>
                        <td>3</td>
                        <td>Network</td>
                        <td>Logical addressing (IP)</td>
                        <td>IP Addressing and Routing</td>
                    </tr>
                    <tr>
                        <td>2</td>
                        <td>Data Link</td>
                        <td>Physical addressing (MAC)</td>
                        <td>Ethernet/Wi-Fi connection</td>
                    </tr>
                    <tr>
                        <td>1</td>
                        <td>Physical</td>
                        <td>Physical medium</td>
                        <td>Cables/Fiber/Wireless</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <h2 style="text-align: center; color: #667eea; margin-bottom: 20px;">üöâ The HTTPS Journey</h2>
        <p style="text-align: center; margin-bottom: 20px; color: #666;">Click on each stop to learn what happens at that stage</p>

        <div class="map-container" id="terminal-map">
            <div class="map-line"></div>
            
            <div class="stop" data-step="0" data-osi="7">
                <div class="stop-title">Stop 1: The Request</div>
                <div class="stop-layer">OSI Layer 7 - Application</div>
            </div>

            <div class="stop" data-step="1" data-osi="app">
                <div class="stop-title">Stop 2: DNS Lookup</div>
                <div class="stop-layer">Application Helper</div>
            </div>

            <div class="stop" data-step="2" data-osi="4">
                <div class="stop-title">Stop 3: TCP Handshake</div>
                <div class="stop-layer">OSI Layer 4 - Transport</div>
            </div>

            <div class="stop" data-step="3" data-osi="6-5">
                <div class="stop-title">Stop 4: TLS ClientHello</div>
                <div class="stop-layer">OSI Layers 5-6 - Session/Presentation</div>
            </div>

            <div class="stop" data-step="4" data-osi="6-5">
                <div class="stop-title">Stop 5: TLS ServerHello</div>
                <div class="stop-layer">OSI Layers 5-6 - Session/Presentation</div>
            </div>

            <div class="stop" data-step="5" data-osi="6-5">
                <div class="stop-title">Stop 6: Certificate Verification</div>
                <div class="stop-layer">OSI Layers 5-6 - Session/Presentation</div>
            </div>

            <div class="stop" data-step="6" data-osi="6-5">
                <div class="stop-title">Stop 7: Key Exchange</div>
                <div class="stop-layer">OSI Layers 5-6 - Session/Presentation</div>
            </div>

            <div class="stop" data-step="7" data-osi="6-5">
                <div class="stop-title">Stop 8: Shared Secret Creation</div>
                <div class="stop-layer">OSI Layers 5-6 - Session/Presentation</div>
            </div>

            <div class="stop" data-step="8" data-osi="7">
                <div class="stop-title">Stop 9: Encrypted Data Transfer</div>
                <div class="stop-layer">OSI Layer 7 - Application</div>
            </div>
        </div>

        <div class="details" id="details-panel"></div>

        <div class="button-row">
            <button class="test-button" onclick="testConnection()" id="primary-action-button">üß™ Test HTTPS Connection</button>
            <button class="test-button secondary-button" type="button" id="return-to-journey-button" style="display: none;">‚¨ÜÔ∏è Return to Journey</button>
        </div>
    </div>

    <script>
        const errorScenarios = [
            {
                stopIndex: 0,
                stage: "Application Request",
                errors: [
                    {
                        code: "ERR_INVALID_URL",
                        message: "The requested URL is not valid.",
                        cause: "The browser request was made with a malformed or incomplete URL.",
                        hint: "Check for typos in the URL (protocol, host, path)."
                    }
                ]
            },
            {
                stopIndex: 1,
                stage: "DNS Lookup",
                errors: [
                    {
                        code: "DNS_PROBE_FINISHED_NXDOMAIN",
                        message: "Server IP address could not be found.",
                        cause: "The domain does not exist in DNS or was typed incorrectly.",
                        hint: "Verify the hostname and ensure the DNS record exists and has propagated."
                    },
                    {
                        code: "ENOTFOUND",
                        message: "getaddrinfo ENOTFOUND example.com",
                        cause: "The operating system resolver could not resolve the hostname.",
                        hint: "Confirm local DNS settings and that the DNS server is reachable."
                    }
                ]
            },
            {
                stopIndex: 2,
                stage: "TCP Handshake",
                errors: [
                    {
                        code: "ERR_CONNECTION_REFUSED",
                        message: "The connection was refused by the server.",
                        cause: "Nothing is listening on the target port or a firewall is actively rejecting the connection.",
                        hint: "Ensure the server process is running and listening on the expected port."
                    },
                    {
                        code: "ECONNREFUSED",
                        message: "connect ECONNREFUSED 127.0.0.1:8443",
                        cause: "The client reached the host but the TCP port is closed.",
                        hint: "Start the HTTPS server (for this lab, run 'npm start') and retry."
                    },
                    {
                        code: "ERR_CONNECTION_TIMED_OUT",
                        message: "The connection to the server timed out.",
                        cause: "Packets are being dropped on the network path or the server is overloaded.",
                        hint: "Check network connectivity, VPNs, and firewall rules between client and server."
                    }
                ]
            },
            {
                stopIndex: 3,
                stage: "TLS ClientHello",
                errors: [
                    {
                        code: "handshake_failure",
                        message: "TLS handshake failed during ClientHello.",
                        cause: "The client and server could not agree on protocol version or cipher suites.",
                        hint: "Ensure the server supports modern TLS versions and compatible cipher suites."
                    }
                ]
            },
            {
                stopIndex: 4,
                stage: "TLS ServerHello",
                errors: [
                    {
                        code: "TLSV1_ALERT_PROTOCOL_VERSION",
                        message: "Received TLS alert: protocol version.",
                        cause: "The server rejected the client's TLS version as too old or unsupported.",
                        hint: "Upgrade the client to use TLS 1.2+ and disable legacy protocols."
                    }
                ]
            },
            {
                stopIndex: 5,
                stage: "Certificate Verification",
                errors: [
                    {
                        code: "NET::ERR_CERT_AUTHORITY_INVALID",
                        message: "Your connection is not private.",
                        cause: "The certificate is self-signed or issued by an untrusted certificate authority.",
                        hint: "For this lab, you can proceed after reviewing the warning; in production, use a trusted CA."
                    },
                    {
                        code: "NET::ERR_CERT_COMMON_NAME_INVALID",
                        message: "The certificate does not match this host.",
                        cause: "The certificate's common name or SAN does not match the requested hostname.",
                        hint: "Confirm that the URL hostname matches the certificate's subject (or SAN) exactly."
                    },
                    {
                        code: "NET::ERR_CERT_DATE_INVALID",
                        message: "Certificate has expired or is not yet valid.",
                        cause: "The certificate's validity period does not include the current date.",
                        hint: "Check system clock and renew or regenerate the certificate if necessary."
                    }
                ]
            },
            {
                stopIndex: 6,
                stage: "Key Exchange",
                errors: [
                    {
                        code: "SSL_ERROR_HANDSHAKE_FAILURE_ALERT",
                        message: "TLS key exchange failed.",
                        cause: "The server rejected the key exchange parameters (e.g., unsupported ECDHE curve).",
                        hint: "Ensure both client and server support the same key exchange algorithms and parameter sizes."
                    }
                ]
            },
            {
                stopIndex: 7,
                stage: "Shared Secret Derivation",
                errors: [
                    {
                        code: "DECRYPT_ERROR",
                        message: "TLS decryption failed during Finished message.",
                        cause: "The derived keys do not match between client and server.",
                        hint: "Check for middleboxes modifying handshake traffic or misconfigured TLS offload."
                    }
                ]
            },
            {
                stopIndex: 8,
                stage: "Encrypted Data Transfer",
                errors: [
                    {
                        code: "Mixed Content",
                        message: "The page was loaded over HTTPS, but requested an insecure resource over HTTP.",
                        cause: "Some assets (scripts, images, APIs) are still referenced with http:// URLs.",
                        hint: "Update asset URLs to https:// or use protocol-relative URLs when appropriate."
                    },
                    {
                        code: "502 Bad Gateway",
                        message: "The server received an invalid response from an upstream server.",
                        cause: "TLS terminated correctly at a reverse proxy, but the backend application failed or is unreachable.",
                        hint: "Inspect reverse proxy and backend logs to see why upstream failed to respond."
                    }
                ]
            }
        ];

        const stepsData = [
            {
                title: "Stop 1: The Request (Application Layer)",
                content: `
                    <h3>üåê The Request - Layer 7 (Application)</h3>
                    <p>Everything begins when you type a URL into your browser or click a link. This is where the journey starts!</p>
                    
                    <p><strong>What happens here:</strong></p>
                    <ul>
                        <li>You enter <span class="highlight">https://example.com</span> in your browser</li>
                        <li>The browser parses the URL and identifies the protocol (HTTPS)</li>
                        <li>Port <span class="highlight">443</span> is automatically selected (default for HTTPS)</li>
                        <li>The browser prepares to establish a secure connection</li>
                    </ul>

                    <p><strong>OSI Layer 7 Role:</strong> This is the Application Layer where user-facing protocols like HTTP/HTTPS operate. It's responsible for presenting data to the user and handling application-specific tasks.</p>

                    <div class="code-block">
URL: https://example.com/page
Protocol: HTTPS
Port: 443 (default)
                    </div>

                    <p><strong>Key Point:</strong> The 'S' in HTTPS means this connection will be <span class="highlight">secured with TLS/SSL encryption</span>, which we'll explore in the following stops!</p>
                `
            },
            {
                title: "Stop 2: DNS Lookup",
                content: `
                    <h3>üîç DNS Lookup - Domain Name Resolution</h3>
                    <p>Computers don't understand domain names - they need IP addresses! This is where DNS (Domain Name System) comes in.</p>
                    
                    <p><strong>The DNS Process:</strong></p>
                    <ul>
                        <li>Your browser asks: "What's the IP address for example.com?"</li>
                        <li>It checks the local DNS cache first</li>
                        <li>If not found, it queries your ISP's DNS server</li>
                        <li>The DNS server responds with the IP address (e.g., <span class="highlight">93.184.216.34</span>)</li>
                        <li>This mapping is cached for future requests</li>
                    </ul>

                    <p><strong>Not technically an OSI layer:</strong> DNS is an application-layer protocol (Layer 7) that acts as a helper service. It translates human-readable domain names into machine-readable IP addresses.</p>

                    <div class="code-block">
Request:  example.com ‚Üí ?
Response: example.com ‚Üí 93.184.216.34

DNS Query Type: A Record (IPv4)
Protocol: UDP/TCP on port 53
                    </div>

                    <p><strong>Fun Fact:</strong> DNS queries are typically sent over <span class="highlight">UDP</span> for speed, but can use TCP for larger responses or zone transfers.</p>

                    <h4 style="margin-top: 20px;">üñ•Ô∏è Windows vs macOS vs Linux: Where does the IP come from?</h4>
                    <p>All three operating systems follow the same high-level pattern: <span class="highlight">check local overrides</span>, then <span class="highlight">ask a DNS server</span>. The details differ slightly:</p>

                    <ul>
                        <li><strong>Windows:</strong> Checks <code>C:\\Windows\\System32\\drivers\\etc\\hosts</code> first. Then it uses DNS servers configured on your network adapters or VPN. You can inspect or flush the DNS cache with <code>ipconfig /displaydns</code> and <code>ipconfig /flushdns</code>.</li>
                        <li><strong>macOS:</strong> Checks <code>/etc/hosts</code> first. DNS servers are configured in Network settings or via management profiles. DNS caching is handled by <code>mDNSResponder</code> (you can refresh it with <code>sudo killall -HUP mDNSResponder</code>).</li>
                        <li><strong>Linux:</strong> Also checks <code>/etc/hosts</code> first. DNS servers usually come from <code>/etc/resolv.conf</code> or <code>systemd-resolved</code>. Tools like <code>dig</code>, <code>host</code>, and <code>resolvectl</code> help you see exactly which IP was returned.</li>
                    </ul>

                    <p>In every case, once an IP address is found, the rest of the HTTPS journey (TCP handshake, TLS, and encrypted HTTP) works the same way.</p>
                `
            },
            {
                title: "Stop 3: TCP Handshake (Transport Layer)",
                content: `
                    <h3>ü§ù TCP Three-Way Handshake - Layer 4 (Transport)</h3>
                    <p>Before any secure communication can happen, we need to establish a reliable connection. This is done through TCP's famous "three-way handshake."</p>
                    
                    <p><strong>The Three Steps:</strong></p>
                    <ul>
                        <li><strong>Step 1 - SYN:</strong> Client sends a synchronization packet to the server
                            <div class="code-block">Client ‚Üí Server: SYN (Sequence Number: 1000)</div>
                        </li>
                        <li><strong>Step 2 - SYN-ACK:</strong> Server acknowledges and sends its own sync
                            <div class="code-block">Server ‚Üí Client: SYN-ACK (Seq: 5000, Ack: 1001)</div>
                        </li>
                        <li><strong>Step 3 - ACK:</strong> Client acknowledges the server's response
                            <div class="code-block">Client ‚Üí Server: ACK (Seq: 1001, Ack: 5001)</div>
                        </li>
                    </ul>

                    <p><strong>OSI Layer 4 Role:</strong> The Transport Layer ensures reliable, ordered delivery of data between applications. TCP (Transmission Control Protocol) provides:</p>
                    <ul>
                        <li>‚úÖ Reliable delivery (packets are acknowledged)</li>
                        <li>‚úÖ Ordered delivery (packets arrive in sequence)</li>
                        <li>‚úÖ Error checking (corrupted packets are retransmitted)</li>
                        <li>‚úÖ Flow control (prevents overwhelming the receiver)</li>
                    </ul>

                    <p><strong>Critical Point:</strong> TCP establishes the reliable channel <span class="highlight">BEFORE</span> TLS encryption begins. No encryption happens at this stage - it's just establishing the connection!</p>
                `
            },
            {
                title: "Stop 4: TLS ClientHello",
                content: `
                    <h3>üëã TLS ClientHello - Layers 5-6 (Session/Presentation)</h3>
                    <p>Now that TCP connection is established, the TLS handshake begins! The client sends the first message.</p>
                    
                    <p><strong>ClientHello Message Contains:</strong></p>
                    <ul>
                        <li><strong>TLS Version:</strong> Highest version supported (e.g., TLS 1.3, TLS 1.2)</li>
                        <li><strong>Client Random:</strong> A 32-byte random number (used later for key generation)</li>
                        <li><strong>Cipher Suites:</strong> List of encryption algorithms the client supports
                            <div class="code-block">
Examples:
- TLS_AES_128_GCM_SHA256
- TLS_AES_256_GCM_SHA384
- TLS_CHACHA20_POLY1305_SHA256
                            </div>
                        </li>
                        <li><strong>Compression Methods:</strong> Usually "null" (no compression) for security</li>
                        <li><strong>Extensions:</strong> Additional features like Server Name Indication (SNI)</li>
                    </ul>

                    <p><strong>OSI Layers 5-6 Role:</strong></p>
                    <ul>
                        <li><strong>Session Layer (5):</strong> Manages the TLS session and its lifetime</li>
                        <li><strong>Presentation Layer (6):</strong> Handles encryption/decryption and data format negotiation</li>
                    </ul>

                    <p><strong>Key Point:</strong> The <span class="highlight">Client Random</span> is crucial - it will be combined with other values later to create the encryption keys. This ensures each session has unique keys!</p>
                `
            },
            {
                title: "Stop 5: TLS ServerHello",
                content: `
                    <h3>üîê TLS ServerHello - Layers 5-6 (Session/Presentation)</h3>
                    <p>The server responds to the client's hello with its own choices and credentials.</p>
                    
                    <p><strong>ServerHello Message Contains:</strong></p>
                    <ul>
                        <li><strong>TLS Version:</strong> The version the server has chosen to use</li>
                        <li><strong>Server Random:</strong> Another 32-byte random number (different from client's)</li>
                        <li><strong>Chosen Cipher Suite:</strong> The server picks ONE from the client's list
                            <div class="code-block">
Selected: TLS_AES_256_GCM_SHA384
(256-bit AES encryption in GCM mode with SHA-384 hashing)
                            </div>
                        </li>
                        <li><strong>Session ID:</strong> For potentially resuming this session later</li>
                    </ul>

                    <p><strong>Server Also Sends:</strong></p>
                    <ul>
                        <li><strong>Certificate:</strong> The server's SSL/TLS certificate (contains public key)</li>
                        <li><strong>Certificate Chain:</strong> Intermediate certificates linking to a root CA</li>
                        <li><strong>Server Key Exchange:</strong> Additional parameters for key agreement</li>
                        <li><strong>ServerHelloDone:</strong> Indicates the server is finished</li>
                    </ul>

                    <p><strong>Important:</strong> Both the <span class="highlight">Client Random</span> and <span class="highlight">Server Random</span> are transmitted in plain text. This is okay because they alone aren't enough to derive the encryption keys - you need the Pre-Master Secret too (coming next)!</p>

                    <div class="code-block">
Client Random: a1b2c3d4... (32 bytes)
Server Random: e5f6g7h8... (32 bytes)
Cipher Suite:  TLS_AES_256_GCM_SHA384
                    </div>
                `
            },
            {
                title: "Stop 6: Certificate Verification",
                content: `
                    <h3>üîç Certificate Verification - Asymmetric Encryption</h3>
                    <p>This is one of the most critical security steps! The client must verify it's talking to the legitimate server.</p>
                    
                    <p><strong>What's in the Certificate:</strong></p>
                    <ul>
                        <li><strong>Domain Name:</strong> The site it's valid for (e.g., example.com)</li>
                        <li><strong>Public Key:</strong> Used for encryption (part of asymmetric cryptography)</li>
                        <li><strong>Issuer:</strong> The Certificate Authority (CA) that signed it</li>
                        <li><strong>Validity Period:</strong> Start and expiration dates</li>
                        <li><strong>Digital Signature:</strong> The CA's cryptographic signature</li>
                    </ul>

                    <p><strong>Verification Process:</strong></p>
                    <ul>
                        <li><strong>Step 1:</strong> Check if the certificate is for the correct domain</li>
                        <li><strong>Step 2:</strong> Check if the certificate has expired</li>
                        <li><strong>Step 3:</strong> Verify the CA's digital signature using the CA's public key
                            <div class="code-block">
Certificate Chain:
example.com (Server Cert)
    ‚Üì signed by
Let's Encrypt (Intermediate CA)
    ‚Üì signed by
ISRG Root X1 (Root CA - Trusted by browser)
                            </div>
                        </li>
                        <li><strong>Step 4:</strong> Check if the certificate has been revoked (OCSP/CRL check)</li>
                    </ul>

                    <p><strong>Asymmetric Encryption:</strong> The certificate contains a <span class="highlight">public key</span>. The server has the corresponding <span class="highlight">private key</span>. Data encrypted with the public key can ONLY be decrypted with the private key.</p>

                    <p><strong>Trust Chain:</strong> Your browser comes with a list of trusted root CAs. If the certificate chain leads back to one of these trusted roots, the certificate is considered valid!</p>

                    <p><strong>‚ö†Ô∏è Warning Signs:</strong> If verification fails, you see the dreaded "Your connection is not private" warning!</p>
                `
            },
            {
                title: "Stop 7: Key Exchange",
                content: `
                    <h3>üîë Key Exchange - Creating the Pre-Master Secret</h3>
                    <p>Now comes the clever part: how do the client and server create a shared secret key without anyone else being able to figure it out?</p>
                    
                    <p><strong>Modern Method: Diffie-Hellman Key Exchange (DHE/ECDHE)</strong></p>
                    <p>Instead of the client simply encrypting a random number with the server's public key, modern TLS uses Diffie-Hellman. Here's how it works:</p>

                    <ul>
                        <li><strong>Both parties agree on:</strong> A large prime number and a generator (public parameters)</li>
                        <li><strong>Client generates:</strong> A private key (secret, never shared) and calculates a public key</li>
                        <li><strong>Server generates:</strong> Its own private key (secret) and calculates a public key</li>
                        <li><strong>Exchange:</strong> They swap public keys (safe to do over an insecure channel!)</li>
                        <li><strong>Magic:</strong> Each uses their own private key + the other's public key to arrive at the <span class="highlight">same shared secret</span>!</li>
                    </ul>

                    <div class="code-block">
Simplified Example:
Client: private=5, calculates public=13
Server: private=7, calculates public=11

Exchange public keys...

Client: Uses 5 and 11 ‚Üí Result: 23
Server: Uses 7 and 13 ‚Üí Result: 23

Both have the same secret: 23!
(Real crypto uses MUCH larger numbers)
                    </div>

                    <p><strong>Why This is Better:</strong></p>
                    <ul>
                        <li>‚úÖ <strong>Perfect Forward Secrecy:</strong> Each session gets unique keys</li>
                        <li>‚úÖ <strong>Eavesdropper can't derive the secret:</strong> Even if they see everything!</li>
                        <li>‚úÖ <strong>Past sessions stay secure:</strong> Even if the server's private key is compromised later</li>
                    </ul>

                    <p><strong>The Result:</strong> Both client and server now have the <span class="highlight">Pre-Master Secret</span> - a shared secret value that only they know!</p>
                `
            },
            {
                title: "Stop 8: Shared Secret Creation",
                content: `
                    <h3>üéØ Master Secret & Session Keys Derivation</h3>
                    <p>We have all the ingredients! Now let's bake the encryption keys.</p>
                    
                    <p><strong>Key Derivation Process:</strong></p>
                    <ul>
                        <li><strong>Inputs:</strong>
                            <div class="code-block">
1. Client Random (32 bytes) - from ClientHello
2. Server Random (32 bytes) - from ServerHello
3. Pre-Master Secret (48 bytes) - from key exchange
                            </div>
                        </li>
                        <li><strong>Process:</strong> These are combined using a Pseudorandom Function (PRF)
                            <div class="code-block">
Master Secret = PRF(
    Pre-Master Secret,
    "master secret",
    Client Random + Server Random
)
                            </div>
                        </li>
                        <li><strong>Output:</strong> A 48-byte Master Secret</li>
                    </ul>

                    <p><strong>Generating Session Keys:</strong></p>
                    <p>The Master Secret is then used to derive multiple session keys:</p>
                    <ul>
                        <li><strong>Client Write Key:</strong> Encrypts data from client to server</li>
                        <li><strong>Server Write Key:</strong> Encrypts data from server to client</li>
                        <li><strong>Client MAC Key:</strong> For message authentication (integrity)</li>
                        <li><strong>Server MAC Key:</strong> For message authentication (integrity)</li>
                        <li><strong>Initialization Vectors (IVs):</strong> For certain cipher modes</li>
                    </ul>

                    <div class="code-block">
Session Keys = PRF(
    Master Secret,
    "key expansion",
    Server Random + Client Random
)

Result: Multiple keys for symmetric encryption!
                    </div>

                    <p><strong>Why Symmetric Encryption Now?</strong></p>
                    <ul>
                        <li>‚ö° <strong>Much faster</strong> than asymmetric encryption</li>
                        <li>üîê <strong>Equally secure</strong> when keys are properly exchanged</li>
                        <li>üí™ <strong>Perfect for bulk data</strong> like web pages, images, videos</li>
                    </ul>

                    <p><strong>Key Point:</strong> We used <span class="highlight">asymmetric encryption</span> (slow but secure for key exchange) to establish <span class="highlight">symmetric encryption</span> (fast and secure for data transfer). Best of both worlds!</p>
                `
            },
            {
                title: "Stop 9: Encrypted Data Transfer",
                content: `
                    <h3>üöÄ Encrypted Data Transfer - The Secure Channel is Open!</h3>
                    <p>Success! The TLS handshake is complete, and we now have a secure, encrypted communication channel.</p>
                    
                    <p><strong>What Happens Now:</strong></p>
                    <ul>
                        <li>Both client and server send a <strong>"ChangeCipherSpec"</strong> message</li>
                        <li>This signals: "All future messages will be encrypted with our session keys"</li>
                        <li>Both send an encrypted <strong>"Finished"</strong> message to verify everything works</li>
                        <li>If both can decrypt the Finished messages, the handshake succeeded!</li>
                    </ul>

                    <p><strong>The Secure HTTP Request:</strong></p>
                    <p>Finally, the browser sends the actual HTTP request - but now it's encrypted!</p>

                    <div class="code-block">
Encrypted Request:
POST /api/login HTTP/1.1
Host: example.com
Content-Type: application/json

{"username": "alice", "password": "secret123"}

‚Üì Encrypted with AES-256-GCM ‚Üì

89a7f3e2d4c1... [binary encrypted data]
                    </div>

                    <p><strong>Security Features Active:</strong></p>
                    <ul>
                        <li>‚úÖ <strong>Confidentiality:</strong> Data is encrypted - eavesdroppers see gibberish</li>
                        <li>‚úÖ <strong>Integrity:</strong> MAC ensures data hasn't been tampered with</li>
                        <li>‚úÖ <strong>Authentication:</strong> Certificate proves server identity</li>
                        <li>‚úÖ <strong>Forward Secrecy:</strong> Session keys can't be recovered later</li>
                    </ul>

                    <p><strong>What an Attacker Sees:</strong></p>
                    <div class="code-block">
Source IP: 192.168.1.100
Dest IP: 93.184.216.34
Port: 443
Protocol: TLS 1.3

[Encrypted Data: 2847 bytes of random-looking data]
[Encrypted Data: 1893 bytes of random-looking data]
[Encrypted Data: 94721 bytes of random-looking data]

Cannot determine:
‚ùå What page was requested
‚ùå What data was sent
‚ùå Login credentials
‚ùå Personal information
                    </div>

                    <p><strong>Back to Layer 7:</strong> We're back at the Application Layer, but now everything is wrapped in encryption! HTTPS = HTTP inside a TLS tunnel.</p>

                    <p><strong>üéâ Congratulations!</strong> You now understand the complete HTTPS handshake process and how the OSI model layers work together to create secure web communications!</p>

                    <p><strong>Performance Note:</strong> This entire handshake takes only 1-2 round trips in TLS 1.3 (faster than older versions), typically completing in 100-300 milliseconds!</p>
                `
            }
        ];

        // Handle stop clicks
        const stops = document.querySelectorAll('.stop');
        const detailsPanel = document.getElementById('details-panel');
        const returnToJourneyButton = document.getElementById('return-to-journey-button');
        const terminalMap = document.getElementById('terminal-map');

        // Learning Lab elements
        const learningLab = document.getElementById('learning-lab');
        const labLine = document.getElementById('lab-line');
        const labPlayButton = document.getElementById('lab-play-button');
        const labPauseButton = document.getElementById('lab-pause-button');
        const labStatus = document.getElementById('lab-status');
        const labErrorsList = document.getElementById('lab-errors-list');

        stops.forEach((stop, index) => {
            stop.addEventListener('click', () => {
                // Remove active class from all stops
                stops.forEach(s => s.classList.remove('active'));
                
                // Add active class to clicked stop
                stop.classList.add('active');
                
                // Update details panel
                detailsPanel.innerHTML = stepsData[index].content;
                detailsPanel.classList.add('show');

                // Show return-to-journey button when viewing a specific stop
                if (returnToJourneyButton) {
                    returnToJourneyButton.style.display = 'inline-block';
                }
                
                // Smooth scroll to details
                detailsPanel.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            });
        });

        if (returnToJourneyButton && terminalMap) {
            returnToJourneyButton.addEventListener('click', () => {
                terminalMap.scrollIntoView({ behavior: 'smooth', block: 'start' });
            });
        }

        // --- Learning Lab: animated transit-style journey ---
        let labStops = [];
        let labTrain;
        let labCurrentIndex = 0;
        let labTimer = null;

        function createLearningLabStops() {
            if (!labLine || labStops.length || !stepsData || !stepsData.length) return;

            const total = stepsData.length;
            const stepIcons = ['üåê','üîç','ü§ù','üì°','üõ°Ô∏è','üìú','üîë','üéØ','üì¶'];

            for (let i = 0; i < total; i++) {
                const fraction = total === 1 ? 0.5 : i / (total - 1);

                const stopEl = document.createElement('div');
                stopEl.className = 'lab-stop-node';
                stopEl.style.position = 'absolute';
                stopEl.style.top = '50%';
                stopEl.style.transform = 'translate(-50%, -50%)';
                stopEl.style.left = `${5 + fraction * 90}%`;
                stopEl.style.width = '18px';
                stopEl.style.height = '18px';
                stopEl.style.borderRadius = '50%';
                stopEl.style.border = '3px solid #667eea';
                stopEl.style.background = '#fff';
                stopEl.style.cursor = 'pointer';
                stopEl.style.display = 'flex';
                stopEl.style.alignItems = 'center';
                stopEl.style.justifyContent = 'center';
                stopEl.style.fontSize = '11px';
                stopEl.title = stepsData[i].title;
                stopEl.textContent = stepIcons[i] || 'üöè';

                stopEl.addEventListener('click', () => {
                    setLabActiveIndex(i, true);
                });

                labLine.appendChild(stopEl);
                labStops.push(stopEl);
            }

            labTrain = document.createElement('div');
            labTrain.id = 'lab-train';
            labTrain.style.position = 'absolute';
            labTrain.style.top = '50%';
            labTrain.style.left = '5%';
            labTrain.style.transform = 'translate(-50%, -50%)';
            labTrain.style.width = '26px';
            labTrain.style.height = '26px';
            labTrain.style.borderRadius = '50%';
            labTrain.style.background = '#ffcc00';
            labTrain.style.boxShadow = '0 0 10px rgba(255, 204, 0, 0.8)';
            labTrain.style.display = 'flex';
            labTrain.style.alignItems = 'center';
            labTrain.style.justifyContent = 'center';
            labTrain.style.fontSize = '14px';
            labTrain.textContent = 'üöÜ';
            labTrain.style.transition = 'left 0.7s ease-out';

            labLine.appendChild(labTrain);
            setLabActiveIndex(0, false);
        }

        function setLabActiveIndex(index, userInitiated) {
            if (!labStops.length || index < 0 || index >= labStops.length) return;
            labCurrentIndex = index;

            labStops.forEach((s, i) => {
                s.style.background = i === index ? '#667eea' : '#fff';
                s.style.boxShadow = i === index ? '0 0 10px rgba(102, 126, 234, 0.8)' : 'none';
            });

            const total = labStops.length;
            const fraction = total === 1 ? 0.5 : index / (total - 1);
            labTrain.style.left = `${5 + fraction * 90}%`;

            if (labStatus && stepsData[index]) {
                labStatus.innerHTML = `<strong>Current Stop:</strong> ${stepsData[index].title}`;
            }

            // Update Common Issues panel for this stage
            if (labErrorsList) {
                labErrorsList.innerHTML = '';
                const scenario = errorScenarios.find(e => e.stopIndex === index);
                if (scenario && Array.isArray(scenario.errors)) {
                    scenario.errors.forEach(err => {
                        const li = document.createElement('li');
                        li.style.marginBottom = '6px';
                        li.innerHTML = `
                            <strong>${err.code}</strong> ‚Äì ${err.message}<br/>
                            <span style="color:#555;">Cause:</span> ${err.cause}<br/>
                            <span style="color:#555;">Hint:</span> ${err.hint}
                        `;
                        labErrorsList.appendChild(li);
                    });
                }
            }
        }

        function startLabAutoPlay() {
            if (!learningLab || !labStops.length) return;
            if (labTimer) window.clearInterval(labTimer);

            if (labPlayButton && labPauseButton) {
                labPlayButton.style.display = 'none';
                labPauseButton.style.display = 'inline-block';
            }

            labTimer = window.setInterval(() => {
                const next = labCurrentIndex + 1;
                if (next >= labStops.length) {
                    window.clearInterval(labTimer);
                    labTimer = null;
                    if (labPlayButton && labPauseButton) {
                        labPlayButton.style.display = 'inline-block';
                        labPauseButton.style.display = 'none';
                    }
                    return;
                }
                setLabActiveIndex(next, true);
            }, 2800);
        }

        function pauseLabAutoPlay() {
            if (labTimer) {
                window.clearInterval(labTimer);
                labTimer = null;
            }
            if (labPlayButton && labPauseButton) {
                labPlayButton.style.display = 'inline-block';
                labPauseButton.style.display = 'none';
            }
        }

        if (labPlayButton) {
            labPlayButton.addEventListener('click', () => {
                createLearningLabStops();
                setLabActiveIndex(0, false);
                startLabAutoPlay();
            });
        }

        if (labPauseButton) {
            labPauseButton.addEventListener('click', () => {
                pauseLabAutoPlay();
            });
        }

        // Lab is always visible at the top now; no explicit close handler

        // Test connection function
        async function testConnection() {
            const protocol = window.location.protocol;
            const isHttps = protocol === 'https:';
            
            try {
                const response = await fetch('/test-connection');
                const data = await response.json();
                
                detailsPanel.innerHTML = `
                    <h3>üß™ Connection Test Results</h3>
                    <div style="background: ${isHttps ? '#d4edda' : '#fff3cd'}; padding: 20px; border-radius: 8px; border: 2px solid ${isHttps ? '#28a745' : '#ffc107'};">
                        <p style="font-size: 1.2em; margin-bottom: 10px;">
                            <strong>Protocol:</strong> <span class="highlight">${protocol.toUpperCase().replace(':', '')}</span>
                        </p>
                        <p style="font-size: 1.2em; margin-bottom: 10px;">
                            <strong>Status:</strong> <span class="highlight">${data.status}</span>
                        </p>
                        <p style="font-size: 1.2em;">
                            <strong>Message:</strong> ${data.message}
                        </p>
                    </div>
                    
                    <p style="margin-top: 20px;"><strong>Current Page URL:</strong></p>
                    <div class="code-block">${window.location.href}</div>
                    
                    ${isHttps ? `
                        <p style="margin-top: 20px;">‚úÖ <strong>You're using HTTPS!</strong> All the encryption steps we discussed are protecting your connection right now.</p>
                        <p>Your browser negotiated a TLS connection with the server, verified the certificate, performed a key exchange, and established symmetric encryption for this session.</p>
                    ` : `
                        <p style="margin-top: 20px;">‚ö†Ô∏è <strong>You're using HTTP.</strong> To see HTTPS in action, visit: <a href="https://localhost:8443" style="color: #667eea; font-weight: bold;">https://localhost:8443</a></p>
                        <p>Your browser will warn you about the self-signed certificate - this is expected! Click "Advanced" and proceed to see the secure version.</p>
                    `}
                    
                    <p style="margin-top: 20px;"><strong>Try this:</strong> Open your browser's Developer Tools (F12) ‚Üí Security tab ‚Üí Click "View Certificate" to see the actual certificate used for this connection!</p>
                `;
                detailsPanel.classList.add('show');
                detailsPanel.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                
            } catch (error) {
                detailsPanel.innerHTML = `
                    <h3>‚ùå Connection Test Failed</h3>
                    <p>Error: ${error.message}</p>
                `;
                detailsPanel.classList.add('show');
            }
        }

        // Add keyboard navigation
        document.addEventListener('keydown', (e) => {
            const activeStop = document.querySelector('.stop.active');
            if (!activeStop) return;
            
            const stops = Array.from(document.querySelectorAll('.stop'));
            const currentIndex = stops.indexOf(activeStop);
            
            if (e.key === 'ArrowDown' && currentIndex < stops.length - 1) {
                stops[currentIndex + 1].click();
            } else if (e.key === 'ArrowUp' && currentIndex > 0) {
                stops[currentIndex - 1].click();
            }
        });
    </script>
</body>
</html>
